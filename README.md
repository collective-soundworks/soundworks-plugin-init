# soundworks | plugin platform init

[![npm version](https://badge.fury.io/js/@soundworks%2Fplugin-platform-init.svg)](https://badge.fury.io/js/@soundworks%2Fplugin-platform)

[`soundworks`](https://soundworks.dev) plugin to handle initialization of browser client features that require a user interaction such as resuming audio context, etc.

**_Tutorial_**: [https://soundworks.dev/tutorials/plugin-platform-init.html](https://soundworks.dev/tutorials/plugin-platform-init.html)

## Table of Contents

<!-- toc -->

- [Installation](#installation)
- [Usage](#usage)
  * [Server](#server)
  * [Client](#client)
- [Available features](#available-features)
- [API](#api)
  * [Classes](#classes)
  * [PluginPlatformInitClient](#pluginplatforminitclient)
  * [PluginPlatformInitServer](#pluginplatforminitserver)
- [Credits](#credits)
- [License](#license)

<!-- tocstop -->

## Installation

```sh
npm install @soundworks/plugin-platform-init --save
```

## Usage

### Server

```js
// src/server/index.js
import { Server } from '@soundworks/core/server.js';
import ServerPluginPlatformInit from '@soundworks/plugin-platform-init/server.js';

const server = new Server(config);
//
server.pluginManager.register('platform-init', ServerPluginPlatformInit);
```

### Client

```js
// src/clients/**/index.js
import { Client } from '@soundworks/core/client.js';
import ClientPluginPlatformInit from '@soundworks/plugin-platform-init/client.js';

const client = new Client(config);
const audioContext = new AudioContext();
// pass the audio context to the plugin
client.pluginManager.register('platform-init', ClientPluginPlatformInit, { audioContext });

await client.start();

console.log(audioContext.state === 'running');
```

## Available features

By default, the `@soundworks/plugin-platform-init` provide a way to resume audio context (as shown above) but also to access microphone, camera streams, and motion sensors through the [`@ircam/devicemotion`](https://www.npmjs.com/package/@ircam/devicemotion) package.

```sh
npm install --save @ircam/devicemotion
```

```js
// src/clients/**/index.js
import { Client } from '@soundworks/core/client.js';
import ClientPluginPlatformInit from '@soundworks/plugin-platform-init/client.js';
import devicemotion from '@ircam/devicemotion';

const client = new Client(config);

client.pluginManager.register('platform-init', ClientPluginPlatformInit, {
  microphone: true,
  camera: true,
  devicemotion,
});

await client.start();

const platformInit = await client.pluginManager.get('platform-init');

const micStream = platformInit.get('microphone');
const cameraStream = platformInit.get('camera');
devicemotion.addEventListener(e => console.log(e));
```

_Note that these additional features require a https connection._

You can also add any arbitrary logic by passing a function to the `onCheck` and
`onActivate` options:

```js
let onCheckCalled = false;
let onActivateCalled = false;

client.pluginManager.register('platform-init', ClientPluginPlatformInit, {
  onCheck: (plugin) => {
    onCheckCalled = true;
    return Promise.resolve();
  },
  onActivate: (plugin) => {
    onActivateCalled = true;
    return Promise.resolve();
  }
});
```

## API

<!-- api -->
<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [ClientPluginPlatformInit][1]
    *   [Examples][2]
    *   [onUserGesture][3]
    *   [get][4]
*   [ServerPluginPlatformInit][5]

## ClientPluginPlatformInit

**Extends ClientPlugin**

Client-side representation of the platform init plugin.

The constructor should never be called manually. The plugin will be
instantiated by soundworks when registered in the `pluginManager`

Available options:

*   `audioContext` {AudioContext} - Instance of AudioContext to be resumed
    aliases: \['webaudio', 'audio-context', 'audioContext']
*   `devicemotion` {DeviceMotion} - `@ircam/devicemotion` module.
    aliases: \['devicemotion', 'device-motion']
*   `micro` {Boolean} - create a microphone stream with all feature (i.e.
    echoCancellation, noiseReduction, autoGainControl) set to false.
    *   aliases: \['mic', 'micro']
    *   todo: implement `deviceId`
*   `video` {Boolean} - create a camera stream
    *   todo: implement `deviceId`
*   `onCheck` {Function} - function executed when the plugin is started to check
    for example if the feature is available. The provided function should return
    a Promise.
*   `onActive` {Function} - function executed on the user gesture to init a feature.
    The provided function should return a Promise.

### Examples

```javascript
client.pluginManager.register('platform-init', platformInitPlugin, { audioContext });
```

### onUserGesture

Method to be called by the application on the first user gesture, i.e. a 'click' event
(cf. [https://developers.google.com/web/updates/2017/09/autoplay-policy-changes][6])

Calling this method several times will result in a no-op after the first call.

By default, this method is automatically called by the launcher. Therefore, in
most cases, you should not have to call it manually.

#### Parameters

*   `event` &#x20;

#### Examples

```javascript
myView.addEventListener('click', (e) => platformPlugin.onUserGesture(e));
```

### get

Returns the payload associated to a given feature.

#### Parameters

*   `featureId` **[String][7]** Id of the feature as given during plugin registration

## ServerPluginPlatformInit

**Extends ServerPlugin**

Server-side representation of the platform init plugin.

[1]: #clientpluginplatforminit

[2]: #examples

[3]: #onusergesture

[4]: #get

[5]: #serverpluginplatforminit

[6]: https://developers.google.com/web/updates/2017/09/autoplay-policy-changes

[7]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

<!-- apistop -->

## Credits

[https://soundworks.dev/credits.html](https://soundworks.dev/credits.html)

## License

[BSD-3-Clause](./LICENSE)
